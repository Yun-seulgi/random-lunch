<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>랜덤 런치 🚗 팀메이커 (3/4인 전용)</title>
  <style>
    :root{
      --bg:#f7f7fb; --card:#fff; --ink:#111; --sub:#6b7280; --line:#e8e9ef;
      --brand:#0f172a; --brand-ink:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",Arial}
    .wrap{max-width:1120px;margin:auto;padding:16px}
    .toolbar{position:sticky;top:0;background:#ffffffcc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px);z-index:10}
    .toolbar .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 16px}
    .h1{display:flex;align-items:center;gap:8px;font-weight:800}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--brand);color:var(--brand-ink)}
    .ctrls{display:flex;gap:8px;flex-wrap:wrap}

    .grid{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 14px rgba(15,23,42,.06);padding:16px}
    .grid-cards{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:16px}
    @media(min-width:640px){.grid-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1024px){.grid-cards{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .panel{display:grid;grid-template-columns:1.5fr .9fr;gap:16px;margin:16px 0}
    @media(max-width:860px){.panel{grid-template-columns:1fr}}
    textarea{width:100%;height:180px;border:1px solid var(--line);border-radius:12px;padding:12px;resize:vertical;font:14px/1.45 inherit}
    .hint{color:var(--sub);font-size:12px;margin-top:6px}
    .box{border:1px solid var(--line);border-radius:14px;background:#fff;padding:14px}
    .field{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:8px 0}
    .field input{border:1px solid var(--line);border-radius:10px;padding:6px 10px;width:200px}
    .muted{color:var(--sub)}

    .titlebar{display:flex;align-items:flex-end;justify-content:space-between;padding:8px 4px}
    .titlebar h2{margin:0;font-weight:900}
    .subtitle{color:var(--sub)}

    .card{position:relative;border:1px solid var(--line);border-radius:16px;background:var(--card);box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
    .car-wrap{padding:12px}
    .tiny{font-size:12px;color:var(--sub)}
    .foot{display:flex;align-items:center;justify-content:space-between;padding:0 12px 12px 12px;color:var(--sub);font-size:12px}

    /* 좌석 뱃지 */
    .seat{position:absolute;transform:translate(-50%,-50%);}
    .badge{
      position:relative;display:inline-block;background:#fff;border:1px solid var(--line);
      border-radius:10px;padding:4px 8px;font-weight:700;white-space:nowrap;
      box-shadow:0 1px 2px rgba(0,0,0,.06);
      max-width:120px; overflow:hidden; text-overflow:ellipsis; /* 화면에서는 말줄임 */
    }
    .badge.driver{background:#fff7d6;border-color:#facc15}
    .badge .crown{position:relative;margin-right:4px;}

    .error{display:flex;align-items:flex-start;gap:8px;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="bar wrap">
      <div class="h1">🚗 아이샵케어 랜덤 런치 팀메이커 <span class="muted" id="ver"></span></div>
      <div class="ctrls">
        <button class="btn primary" id="btnMake">랜덤 조편성</button>
        <button class="btn" id="btnSave" disabled>PNG로 저장</button>
        <button class="btn" id="btnCopy" disabled>명단 복사</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">
      <div>
        <label class="muted">총 인원 이름 (쉼표로 구분)</label>
        <textarea id="inputNames" placeholder="예) 김민수, 이지은, 박준호"></textarea>
        <div class="hint">현재 인원: <b id="count">0</b>명</div>
      </div>
      <div>
        <div class="box">
          <div class="field">
            <label class="muted">제목</label>
            <input id="title" placeholder="예: 8월 랜덤 런치" />
          </div>
          <div class="hint">※ 5인 조는 만들지 않아요. 인원은 오직 3명/4명으로만 나뉩니다.</div>
          <div id="error" class="error" style="display:none">⚠️ 인원을 3명/4명으로만 나눌 수 없어요. (예: 1, 2, 5명은 불가)</div>
        </div>
      </div>
    </div>

    <div class="titlebar">
      <div>
        <h2 id="outTitle">랜덤 런치</h2>
        <div class="subtitle" id="meta"></div>
      </div>
    </div>

    <div class="grid" id="captureArea">
      <div class="grid-cards" id="cards"></div>
    </div>
  </div>

  <!-- html-to-image (CDN) for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
  <script>
    // ===== Helpers =====
    const byId = id => document.getElementById(id);
    const $names   = byId('inputNames');
    const $count   = byId('count');
    const $btnMake = byId('btnMake');
    const $btnSave = byId('btnSave');
    const $btnCopy = byId('btnCopy');
    const $error   = byId('error');
    const $cards   = byId('cards');
    const $meta    = byId('meta');
    const $titleIn = byId('title');
    const $titleOut= byId('outTitle');
    const $capture = byId('captureArea');

    // 샘플(콤마 구분)
    const sampleNames = [
      '김민수','이지은','박준호','최서윤','정하늘','윤세진','오지호','문가영','한지훈','서수현',
      '김보라','박지성','최민재','신소율','양지훈','강유진','유소라','정민호','최다혜','오민규','류지안','윤다연'
    ];
    $names.value = sampleNames.join(', ');

    // 쉼표 기준 분할(엔터/전각쉼표/세미콜론은 쉼표로 통일), 공백 무시, 중복 허용, 마지막 쉼표 OK
    function splitNames(text){
      const normalized = text
        .replace(/\r?\n+/g, ',')     // 줄바꿈 -> 쉼표
        .replace(/[，、;]+/g, ',');  // 전각 쉼표/세미콜론 -> 쉼표
      return normalized
        .split(',')
        .map(s => s.trim())
        .filter(s => s.length > 0);
    }
    function shuffle(arr){
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
      return a;
    }

    // --- 팀명 사전 (보편적 & 다양) ---
    const adjectives = [
      '멋진','귀여운','용감한','빠른','차분한','당당한','영리한','상큼한','든든한','유쾌한',
      '재치있는','정직한','열정적인','상냥한','활기찬','평화로운','행운의','빛나는','깔끔한','튼튼한',
      '강력한','부드러운','따뜻한','신속한','자유로운','신비로운','센스있는','산뜻한','푸른',
      '은은한','단단한','기운찬','활발한','순수한','대담한','우아한','크림빛','새벽의','황금빛'
    ];
    const nouns = [
      // 동물
      '호랑이','사자','여우','늑대','판다','토끼','다람쥐','곰','고양이','강아지','펭귄','수달','코끼리','기린','돌고래','고래','상어','부엉이','독수리','참새','올빼미','두루미','거북이','하마','표범','치타',
      // 음식/과일
      '피자','버거','치킨','김밥','떡볶이','라면','초밥','만두','우동','파스타','타코','샌드위치','도넛','쿠키','마카롱','케이크','바나나','딸기','사과','복숭아',
      // 캐릭터/직업(일반명)
      '마법사','기사','닌자','해적','도깨비','요정','로봇','우주인','탐험가','용사','드래곤','히어로','연구원','요리사','정찰병','선장','발명가'
    ];
    function teamName(){
      const a = adjectives[Math.floor(Math.random()*adjectives.length)];
      const n = nouns[Math.floor(Math.random()*nouns.length)];
      return a + ' ' + n;
    }

    // n = 3a + 4b (b 최대화) — 3/4인 전용 분할
    function partition34(n){
      if(n===1||n===2||n===5) return null;
      for(let b=Math.floor(n/4); b>=0; b--){
        const rem=n-4*b;
        if(rem%3===0) return {a3:rem/3,b4:b};
      }
      return null;
    }
    function makeGroups34(list){
      const plan = partition34(list.length); if(!plan) return null;
      const s = shuffle(list); const groups=[]; let idx=0;
      for(let i=0;i<plan.b4;i++){ groups.push(s.slice(idx,idx+4)); idx+=4; }
      for(let i=0;i<plan.a3;i++){ groups.push(s.slice(idx,idx+3)); idx+=3; }
      return groups;
    }
    function pickLeaders(groups){
      return groups.map((g,i)=>{
        const leaderIdx=Math.floor(Math.random()*g.length);
        const leader=g[leaderIdx];
        const others=g.filter((_,k)=>k!==leaderIdx);
        return { teamName: teamName(), leader, members:[leader,...others] };
      });
    }

    /* 좌석 좌표(차창 중앙 쪽에 위치) */
    const seatLayout = [
      {key:'driver', x:78,  y:65},   // 앞좌석 왼쪽(조장)
      {key:'front',  x:162, y:65},   // 앞좌석 오른쪽
      {key:'rearL',  x:78,  y:165},  // 뒷좌석 왼쪽
      {key:'rearR',  x:162, y:165},  // 뒷좌석 오른쪽
    ];

    // 세련된 저채도 팔레트
    const carPalette = ['#8da9c4','#a3c4bc','#e6b8a2','#c3aed6','#b8c0ff','#b7e4c7','#f2d0a9','#9fd8df'];

    let teams = [];

    // 배지 크기를 고려해 차창(rect) 안쪽으로 클램프
    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function fitBadgesInsideCar(svgBox){
      const margin = 6;
      // 창 사각형(px): <rect x="35" y="30" width="170" height="70">, <rect x="35" y="130" width="170" height="70">
      const front = { left:35, right:205, top:30, bottom:100, width:170 };
      const rear  = { left:35, right:205, top:130, bottom:200, width:170 };

      [...svgBox.querySelectorAll('.seat')].forEach((seat, idx) => {
        const badge = seat.querySelector('.badge');
        if(!badge) return;
        const w = badge.offsetWidth, h = badge.offsetHeight;
        const area = (idx <= 1) ? front : rear;

        // 현재 left/top은 중심 좌표(translate(-50%,-50%))
        const cx0 = parseFloat(seat.style.left);
        const cy0 = parseFloat(seat.style.top);

        const cx = clamp(cx0, area.left + margin + w/2,  area.right  - margin - w/2);
        const cy = clamp(cy0, area.top  + margin + h/2,  area.bottom - margin - h/2);

        seat.style.left = cx + 'px';
        seat.style.top  = cy + 'px';
      });
    }

    // --- PNG 저장 시: 이름이 안 잘리도록 임시로 배지 너비 확대 후 캡처 ---
    function prepareForExport(){
      const AREA_W = 170;              // 창 너비
      const MAX_W  = AREA_W - 12;      // 좌우 여백 감안(=158px)
      document.querySelectorAll('.car-wrap > div').forEach(svgBox=>{
        svgBox.querySelectorAll('.badge').forEach(b=>{
          b.dataset.prevMax = b.style.maxWidth || '';
          b.dataset.prevOverflow = b.style.textOverflow || '';
          b.style.maxWidth = MAX_W + 'px';      // 말줄임 해제용 넓은 최대치
          b.style.textOverflow = 'clip';        // ... 제거
        });
        fitBadgesInsideCar(svgBox);             // 새 너비 기준으로 재보정
      });
    }
    function restoreAfterExport(){
      document.querySelectorAll('.car-wrap > div').forEach(svgBox=>{
        svgBox.querySelectorAll('.badge').forEach(b=>{
          b.style.maxWidth = b.dataset.prevMax || '';
          b.style.textOverflow = b.dataset.prevOverflow || '';
          delete b.dataset.prevMax; delete b.dataset.prevOverflow;
        });
        fitBadgesInsideCar(svgBox);
      });
    }

    function render(){
      $cards.innerHTML='';
      if(!teams.length){
        const empty = document.createElement('div');
        empty.className='muted';
        empty.style.textAlign='center'; empty.style.padding='60px 0';
        empty.innerHTML='이름을 쉼표로 구분해 입력하고 <b>랜덤 조편성</b>을 눌러주세요!';
        $cards.appendChild(empty);
        $btnSave.disabled = true; $btnCopy.disabled = true; return;
      }
      $btnSave.disabled = false; $btnCopy.disabled = false;

      teams.forEach((t, i)=>{
        const card=document.createElement('div'); card.className='card';
        const head=document.createElement('div'); head.className='card-head';
        head.innerHTML=`<div class="muted">${i+1}호차</div><div style="font-weight:700">${t.teamName}</div>`;
        const tiny=document.createElement('div'); tiny.className='tiny'; tiny.style.padding='0 12px'; tiny.textContent='조장은 운전석';
        const carWrap=document.createElement('div'); carWrap.className='car-wrap';
        const svgBox=document.createElement('div'); svgBox.style.position='relative'; svgBox.style.width='240px'; svgBox.style.height='230px'; svgBox.style.margin='0 auto';
        const color=carPalette[i%carPalette.length];

        // 자동차 도형
        const svg=`<svg width="240" height="230" viewBox="0 0 240 230">
            <defs>
              <linearGradient id="g${i}" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="${color}" stop-opacity="0.95"/>
                <stop offset="100%" stop-color="${color}" stop-opacity="0.75"/>
              </linearGradient>
            </defs>
            <g>
              <circle cx="30"  cy="40"  r="16" fill="#111827"/>
              <circle cx="210" cy="40"  r="16" fill="#111827"/>
              <circle cx="30"  cy="190" r="16" fill="#111827"/>
              <circle cx="210" cy="190" r="16" fill="#111827"/>

              <rect x="20" y="20" rx="24" ry="24" width="200" height="190" fill="url(#g${i})" stroke="#11182722"/>
              <rect x="35" y="30"  width="170" height="70"  rx="18" fill="#ffffffcc"/>
              <rect x="35" y="130" width="170" height="70"  rx="18" fill="#ffffffcc"/>

              <rect x="90" y="8" width="60" height="16" rx="4" fill="#e5e7eb" stroke="#9ca3af"/>
              <text x="120" y="20" text-anchor="middle" font-size="10" fill="#111827">${i+1}팀</text>
            </g>
          </svg>`;
        svgBox.innerHTML = svg;

        // 좌석 이름 뱃지
        const seats=[t.members[0],t.members[1],t.members[2],t.members[3]];
        seatLayout.forEach((s,idx)=>{
          const name = seats[idx]; if(!name) return; // 3인 조는 하나 비움
          const seat=document.createElement('div'); seat.className='seat'; seat.style.left=s.x+'px'; seat.style.top=s.y+'px';
          const badge=document.createElement('div'); badge.className='badge'+(idx===0?' driver':'');
          badge.innerHTML = (idx===0?`<span class="crown">👑</span>`:'') + name;
          badge.title = name;
          seat.appendChild(badge); svgBox.appendChild(seat);
        });

        // DOM 그린 후 창 내부로 보정
        requestAnimationFrame(()=>fitBadgesInsideCar(svgBox));

        carWrap.appendChild(svgBox);
        const foot=document.createElement('div'); foot.className='foot';
        const left=document.createElement('div'); left.innerHTML=`조장: <b>${t.leader}</b>`;
        const right=document.createElement('div');
        const btn=document.createElement('button'); btn.className='btn'; btn.textContent='좌석 다시 뽑기';
        btn.onclick=()=>{ const others=shuffle(t.members.slice(1)); t.members=[t.leader,...others]; render(); };
        right.appendChild(btn);
        foot.appendChild(left); foot.appendChild(right);

        card.appendChild(head); card.appendChild(tiny); card.appendChild(carWrap); card.appendChild(foot);
        $cards.appendChild(card);
      });
    }

    function updateCounts(){ $count.textContent = splitNames($names.value).length; }

    function make(){
      const names = splitNames($names.value); updateCounts();
      $error.style.display='none';
      if(names.length<3){ $error.style.display='block'; teams=[]; render(); return; }
      const g = makeGroups34(names);
      if(!g){ $error.style.display='block'; teams=[]; render(); return; }
      teams = pickLeaders(g);
      $titleOut.textContent = $titleIn.value.trim() || '랜덤 런치';
      $meta.textContent = `총 ${names.length}명 · 3/4인 기준 ${teams.length}개 팀`;
      render();
    }

    // 파일명: 랜덤런치_제목.png (제목이 없으면 '랜덤런치.png')
    function sanitizedTitle(t){
      return t.replace(/[\\/:*?"<>|]/g,'-').trim();
    }
    function savePng(){
      const title  = sanitizedTitle($titleIn.value || '');
      const fname  = title ? `랜덤런치_${title}.png` : '랜덤런치.png';

      prepareForExport(); // 말줄임 해제 & 재보정
      // 레이아웃 적용 후 캡처
      requestAnimationFrame(()=>{
        htmlToImage.toPng($capture,{pixelRatio:2.5,backgroundColor:'#ffffff'})
          .then(url=>{ const a=document.createElement('a'); a.href=url; a.download=fname; a.click(); })
          .catch(()=>alert('이미지 저장 중 오류가 발생했어요. 다시 시도해 주세요.'))
          .finally(()=>{ restoreAfterExport(); });
      });
    }

    function copyList(){
      if(!teams.length) return;
      const text = teams.map((t,i)=>`${i+1}팀(${t.teamName}) - 조장:${t.leader} | ${t.members.join(', ')}`).join('\n');
      navigator.clipboard.writeText(text)
        .then(()=>alert('팀 명단을 복사했어요!'))
        .catch(()=>alert('복사 실패: 브라우저 권한을 확인하세요.'));
    }

    $btnMake.onclick = make;
    $btnSave.onclick = savePng;
    $btnCopy.onclick = copyList;
    $names.addEventListener('input', updateCounts);
    updateCounts();
  </script>
</body>
</html>
